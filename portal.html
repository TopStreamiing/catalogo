<!doctype html>
<html lang="es">
<head>
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="apple-touch-icon" href="assets/favicon.png">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal Clientes</title>

  <style>
    :root{
      --bg1:#060B1A;
      --bg2:#0B1638;
      --card:rgba(12, 21, 48, .78);
      --border:rgba(255,255,255,.10);
      --text:#EAF0FF;
      --muted:rgba(234,240,255,.70);
      --muter:rgba(234,240,255,.52);
      --primary:#2F6BFF;
      --primary2:#1D4ED8;
      --chip:rgba(255,255,255,.08);
      --shadow:0 18px 55px rgba(0,0,0,.45);
      --radius:18px;
      --danger:#ff7a7a;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(47,107,255,.25), transparent 60%),
        radial-gradient(900px 500px at 85% 25%, rgba(155,89,255,.18), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    .wrap{ max-width: 860px; margin: 0 auto; padding: 26px 16px 44px; }
    .header{ display:flex; gap:14px; align-items:center; margin-bottom:18px; flex-wrap:wrap; }

    .logo{
      height:72px; width:auto; border-radius: 14px;
      background: rgba(255,255,255,.06);
      padding:10px;
      border: 1px solid rgba(255,255,255,.10);
    }

    .headtext h1{ font-size: 22px; margin:0; letter-spacing:.2px; }
    .headtext p{ margin:4px 0 0; color: var(--muted); font-size: 13px; }

    .dot{
      display:inline-block; width:8px;height:8px;border-radius:999px;
      background: linear-gradient(135deg, #A855F7, #2F6BFF);
      margin-right:8px; vertical-align: middle;
    }

    .catalogBtn{
      margin-left:auto;
      display:flex;
      flex-direction:column;
      gap:4px;
      padding: 12px 14px;
      border-radius: 14px;
      text-decoration:none;
      color: #fff;
      background: linear-gradient(180deg, rgba(34,197,94,.22), rgba(34,197,94,.08));
      border: 1px solid rgba(34,197,94,.30);
      box-shadow: 0 14px 40px rgba(0,0,0,.28);
      transition: .16s ease;
      white-space: nowrap;
      min-width: 210px;
      align-items:flex-start;
      cursor:pointer;
      user-select:none;
    }
    .catalogBtn:hover{ transform: translateY(-1px); border-color: rgba(34,197,94,.55); }
    .catalogTitle{ font-weight: 1000; font-size: 13px; display:flex; align-items:center; gap:8px; letter-spacing: .2px; }
    .catalogSub{ font-size: 11.5px; color: rgba(234,240,255,.78); font-weight: 800; }
    @media (max-width: 620px){
      .catalogBtn{ min-width: unset; padding: 10px 12px; }
      .catalogSub{ display:none; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(10px);
    }

    .tabs{ display:flex; gap:10px; margin: 8px 0 16px; flex-wrap:wrap; }

    .tab{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 14px;
      cursor:pointer;
      font-weight: 900;
      font-size: 13px;
      transition:.15s ease;
      user-select:none;
    }
    .tab.active{
      background: rgba(47,107,255,.18);
      border-color: rgba(47,107,255,.40);
      box-shadow: 0 10px 30px rgba(47,107,255,.12);
    }

    .grid{ display:grid; gap: 12px; }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      margin-bottom: 8px;
    }

    input, select{
      width:100%;
      box-sizing:border-box;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(8, 14, 32, .55);
      color: var(--text);
      padding: 12px 14px;
      font-size: 14px;
      outline:none;
    }
    input::placeholder{ color: rgba(234,240,255,.45); }

    /* Validaci√≥n visual */
    .fieldWrap{ display:flex; flex-direction:column; gap:6px; }
    .field-error{
      border-color: rgba(255,122,122,.65) !important;
      box-shadow: 0 0 0 3px rgba(255,122,122,.12);
    }
    .err{
      min-height: 16px;
      font-size: 12px;
      color: rgba(255,122,122,.92);
      font-weight: 800;
      line-height: 1.25;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    .btn{
      border:0;
      border-radius: 14px;
      padding: 11px 16px;
      font-weight: 1000;
      cursor:pointer;
      font-size: 14px;
      transition:.15s ease;
    }

    .btn.primary{
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color: #fff;
      box-shadow: 0 14px 35px rgba(47,107,255,.25);
    }
    .btn.primary:hover{ transform: translateY(-1px); }

    .btn.ghost{
      background: rgba(255,255,255,.06);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.10);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size: 12px;
      font-weight: 1000;
    }

    .hint{
      margin-top: 10px;
      color: var(--muter);
      font-size: 12px;
      line-height: 1.35;
    }

    .status{
      margin-top: 12px;
      background: rgba(8, 14, 32, .45);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px 12px;
      color: var(--text);
      font-size: 13px;
      line-height: 1.35;
      min-height: 44px;
    }

    .loader{
      margin-top: 10px;
      color: var(--muted);
      font-weight: 1000;
      font-size: 13px;
      display:none;
    }
    .loader.show{ display:block; }

    .hidden{ display:none !important; }

    @media (min-width: 720px){
      .grid.two{ grid-template-columns: 1fr 1fr; align-items:end; }
      .grid.three{ grid-template-columns: 1fr 1fr 1fr; align-items:end; }
    }

    .resultTitle{ font-weight:1000; font-size:16px; margin-bottom:10px; }
    .greenTitle{ color:#7CFFB2; }
    .yellowTitle{ color:#FFD36E; }
    .redTitle{ color:#FF7A7A; }
    .line{ margin-top:6px; }
    .label2{ color: rgba(234,240,255,.72); }

    .boxLink{
      margin-top:12px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(8, 14, 32, .35);
      border-radius: 14px;
      padding: 12px;
      word-break: break-all;
      color: rgba(234,240,255,.92);
      font-size: 12.5px;
      line-height: 1.35;
    }

    .otpBox{
      margin-top:12px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(8, 14, 32, .35);
      border-radius: 14px;
      padding: 14px 12px;
      text-align:center;
      font-weight: 1000;
      font-size: 26px;
      letter-spacing: 2px;
      color: rgba(234,240,255,.96);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <img class="logo" id="logoImg" alt="Logo" onerror="this.style.display='none'">

      <div class="headtext">
        <h1><span class="dot"></span>Portal de Clientes</h1>
        <p>Selecciona una opci√≥n para continuar. (Hora de referencia: PET)</p>
      </div>

      <div class="catalogBtn" id="btnCatalog">
        <div class="catalogTitle">üõçÔ∏è Volver al cat√°logo</div>
        <div class="catalogSub">Ver planes y disponibilidad ‚Üí</div>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <div id="tabNetflix" class="tab active" onclick="switchTab('netflix')">C√≥digo Netflix</div>
        <div id="tabDisney" class="tab" onclick="switchTab('disney')">C√≥digo Disney</div>
        <div id="tabAccounts" class="tab" onclick="switchTab('accounts')">Mis cuentas</div>
      </div>

      <!-- PANEL NETFLIX -->
      <div id="panelNetflix">
        <div class="grid three">
          <div class="fieldWrap">
            <label>Ingresa tu n√∫mero de celular</label>
            <input id="phoneNetflix" inputmode="tel" placeholder="+51 999 999 999">
            <div class="err" id="errPhoneNetflix"></div>
          </div>

          <div class="fieldWrap">
            <label>PIN de tu perfil (4 d√≠gitos)</label>
            <input id="pinNetflix" inputmode="numeric" maxlength="4" placeholder="0000">
            <div class="err" id="errPinNetflix"></div>
          </div>

          <div class="fieldWrap">
            <label>¬øQu√© opci√≥n te sale?</label>
            <select id="opcionNetflix">
              <option value="" selected disabled>Seleccionar opci√≥n‚Ä¶</option>
              <option value="viaje">Estoy de viaje</option>
              <option value="temporal">Ver temporalmente</option>
              <option value="hogar">Actualizar hogar</option>
            </select>
            <div class="err" id="errOptNetflix"></div>
          </div>
        </div>

        <div class="actions">
          <button id="btnSearchNetflix" class="btn primary" onclick="searchNetflix()" disabled>Buscar c√≥digo</button>
          <button id="btnRetryNetflix" class="btn ghost" onclick="retryNetflix()" disabled>Reintentar</button>
          <span id="remainNetflix" class="chip">Te quedan ‚Äî de 2</span>
        </div>

        <div id="loaderNetflix" class="loader">üîé Buscando‚Ä¶</div>
        <div id="outNetflix" class="status"></div>

        <div class="hint">
          Recuerda darle a <b>‚ÄúEnviar email‚Äù</b> desde tu dispositivo, sino no llegar√°.<br>
          Si a√∫n no aparece, espera 60 segundos y presiona <b>Reintentar</b>. Si persiste, solicita v√≠a WhatsApp con los asesores.
        </div>
      </div>

      <!-- PANEL DISNEY -->
      <div id="panelDisney" class="hidden">
        <div class="grid three">
          <div class="fieldWrap">
            <label>Ingresa tu n√∫mero de celular</label>
            <input id="phoneDisney" inputmode="tel" placeholder="+51 999 999 999">
            <div class="err" id="errPhoneDisney"></div>
          </div>

          <div class="fieldWrap">
            <label>PIN de tu perfil (4 d√≠gitos)</label>
            <input id="pinDisney" inputmode="numeric" maxlength="4" placeholder="0000">
            <div class="err" id="errPinDisney"></div>
          </div>

          <div class="fieldWrap">
            <label>Motivo</label>
            <select id="motivoDisney">
              <option value="" selected disabled>Seleccionar motivo‚Ä¶</option>
              <option value="Iniciar sesi√≥n (Celular/PC)">Iniciar sesi√≥n (Celular/PC)</option>
              <option value="Activar TV">Activar TV</option>
              <option value="Estoy fuera de casa">Estoy fuera de casa</option>
            </select>
            <div class="err" id="errMotivoDisney"></div>
          </div>
        </div>

        <div class="actions">
          <button id="btnSearchDisney" class="btn primary" onclick="searchDisney()" disabled>Buscar c√≥digo</button>
          <button id="btnRetryDisney" class="btn ghost" onclick="retryDisney()" disabled>Reintentar</button>
          <span id="remainDisney" class="chip">Te quedan ‚Äî de 2</span>
        </div>

        <div id="loaderDisney" class="loader">üîé Buscando c√≥digo‚Ä¶</div>
        <div id="outDisney" class="status"></div>

        <div class="hint">
          ‚ö†Ô∏è <b>Importante:</b> No solicites ni compartas c√≥digos innecesariamente.<br>
          Evita solicitar <b>3 c√≥digos consecutivos</b>: Disney+ puede restringir temporalmente el acceso por seguridad (hasta 12 horas).
        </div>
      </div>

      <!-- PANEL CUENTAS -->
      <div id="panelAccounts" class="hidden">
        <div class="grid two">
          <div class="fieldWrap">
            <label>N√∫mero de celular</label>
            <input id="phoneAccount" inputmode="tel" placeholder="+51 904 293 916">
            <div class="err" id="errPhoneAccount"></div>
          </div>

          <div class="fieldWrap">
            <label>Plataforma</label>
            <select id="platform"></select>
            <div class="err" id="errPlatform"></div>
          </div>
        </div>

        <div class="actions">
          <button id="btnAccount" class="btn primary" onclick="checkAccount()" disabled>üßæ Revisar mi cuenta</button>
          <span id="remainAccount" class="chip">Te quedan ‚Äî de 2</span>
        </div>

        <div id="loaderAccount" class="loader">üîé Verificando‚Ä¶</div>
        <div id="outAccount" class="status"></div>
      </div>

    </div>
  </div>

<script>
  /* ======================
     CONFIG (EDITA SOLO ESTO)
     ====================== */
  const API_BASE = "https://chesttop-api.fam-premium2720.workers.dev";
  const CATALOG_URL = "https://www.chesttop.com/";
  const LIMIT_MAX = 2;

  // Logo opcional (si no quieres, d√©jalo vac√≠o)
  const LOGO_URL = "";

  // Plataformas (dropdown Mis cuentas)
  const PLATFORMS = [
    "NETFLIX","DISNEY","MAX","MAXPLATINO","PRIME","VIX","CRUNCHY","CHATGPT",
    "PARAMOUNT","DEEZER","CAPCUT","VIKI","FLUJOTV"
  ];

  const UPDATE_HOME_MESSAGE =
`üè† Actualizar hogar (Netflix)
Este caso no se resuelve con c√≥digo autom√°tico.

‚ö° Requiere cambio de cuenta (soluci√≥n inmediata).
üì≤ Cont√°ctanos por WhatsApp para proceder con ello.

‚úÖ Tip: Si te salen las opciones ‚ÄúEstoy de viaje‚Äù o ‚ÄúVer temporalmente‚Äù, ah√≠ s√≠ podemos generarte el enlace/c√≥digo desde el portal.`;

  const NETFLIX_NO_EMAIL_COPY =
`‚è≥ Espera 60 segundos y presiona Reintentar.
üìå NO dar clic en "Reenviar email".
Si a√∫n no llega el c√≥digo, contacta soporte por WhatsApp.`;

  document.getElementById("btnCatalog").addEventListener("click", () => {
    window.open(CATALOG_URL, "_self");
  });

  const logoImg = document.getElementById("logoImg");
  if (LOGO_URL) logoImg.src = LOGO_URL; else logoImg.style.display = "none";

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function outHTML(elId, html){ document.getElementById(elId).innerHTML = html || ""; }

  function getDeviceId(){
    const k = "ct_device_id";
    let id = localStorage.getItem(k);
    if(!id){
      id = "dvc_" + Math.random().toString(36).slice(2) + "_" + Date.now().toString(36);
      localStorage.setItem(k, id);
    }
    return id;
  }

  function maskEmail(email){
    const e = String(email || "").trim();
    const at = e.lastIndexOf("@");
    if(at < 0) return e;
    const user = e.slice(0, at);
    const dom = e.slice(at);
    if(user.length === 0) return "***" + dom;
    if(user.length === 1) return user[0] + "***" + dom;
    if(user.length === 2) return user.slice(0,2) + "***" + dom;
    return `${user.slice(0,2)}***${user.slice(-1)}${dom}`;
  }

  function switchTab(which){
    const tabN = document.getElementById("tabNetflix");
    const tabD = document.getElementById("tabDisney");
    const tabA = document.getElementById("tabAccounts");
    const panN = document.getElementById("panelNetflix");
    const panD = document.getElementById("panelDisney");
    const panA = document.getElementById("panelAccounts");

    tabN.classList.remove("active");
    tabD.classList.remove("active");
    tabA.classList.remove("active");
    panN.classList.add("hidden");
    panD.classList.add("hidden");
    panA.classList.add("hidden");

    if(which === "netflix"){ tabN.classList.add("active"); panN.classList.remove("hidden"); }
    else if(which === "disney"){ tabD.classList.add("active"); panD.classList.remove("hidden"); }
    else { tabA.classList.add("active"); panA.classList.remove("hidden"); }
  }

  function setRemain(elId, remaining){
    const el = document.getElementById(elId);
    if(typeof remaining === "number") el.textContent = `Te quedan ${remaining} de ${LIMIT_MAX}`;
    else el.textContent = `Te quedan ‚Äî de ${LIMIT_MAX}`;
  }

  function setLoader(elId, on){
    document.getElementById(elId).classList.toggle("show", !!on);
  }

  function renderError(title, msg){
    return `
      <div class="resultTitle redTitle">‚ùå ${esc(title || "No se pudo completar")}</div>
      <div style="color:rgba(234,240,255,.78); font-size:12.5px; line-height:1.35; white-space:pre-line;">
        ${esc(msg || "Intenta nuevamente o contacta soporte.")}
      </div>
    `;
  }

  /* ===== Toast Copiado ===== */
  let toastTimer = null;
  function showToast(msg){
    clearTimeout(toastTimer);
    let t = document.getElementById("toastBox");
    if(!t){
      t = document.createElement("div");
      t.id = "toastBox";
      t.style.position = "fixed";
      t.style.left = "50%";
      t.style.bottom = "22px";
      t.style.transform = "translateX(-50%)";
      t.style.background = "rgba(10,10,20,.88)";
      t.style.color = "#fff";
      t.style.padding = "10px 14px";
      t.style.borderRadius = "999px";
      t.style.border = "1px solid rgba(255,255,255,.15)";
      t.style.fontWeight = "900";
      t.style.fontSize = "13px";
      t.style.zIndex = "9999";
      t.style.display = "none";
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.display = "block";
    toastTimer = setTimeout(() => t.style.display = "none", 1400);
  }

  async function copyText(text) {
    try {
      await navigator.clipboard.writeText(text);
      showToast("‚úÖ Copiado");
    } catch (e) {
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      showToast("‚úÖ Copiado");
    }
  }

  /* ===== Cooldown (con protecci√≥n vs validaci√≥n) ===== */
  const cooldownUntil = { netflix: 0, disney: 0, account: 0 };

  function setButtonsDisabled(ids, disabled){
    ids.forEach(id => {
      const el = document.getElementById(id);
      if(el) el.disabled = !!disabled;
    });
  }

  function startCooldown(sectionKey, buttonIds, seconds, retryIdToLabel){
    cooldownUntil[sectionKey] = Date.now() + seconds * 1000;

    setButtonsDisabled(buttonIds, true);

    const retryBtn = retryIdToLabel ? document.getElementById(retryIdToLabel) : null;
    const originalRetryText = retryBtn ? retryBtn.textContent : "";

    const tick = () => {
      const left = cooldownUntil[sectionKey] - Date.now();
      if(left <= 0){
        cooldownUntil[sectionKey] = 0;
        if(retryBtn) retryBtn.textContent = originalRetryText || "Reintentar";
        // al terminar, revalida para habilitar correctamente
        validateAll();
        return;
      }
      if(retryBtn) retryBtn.textContent = `Reintentar (${Math.ceil(left/1000)}s)`;
      requestAnimationFrame(tick);
    };
    tick();
  }

  /* ===== Validaci√≥n UI ===== */
  function setFieldError(idField, idErr, msg){
    const el = document.getElementById(idField);
    const err = document.getElementById(idErr);
    if(!el || !err) return;

    if(msg){
      el.classList.add("field-error");
      err.textContent = msg;
    }else{
      el.classList.remove("field-error");
      err.textContent = "";
    }
  }

  function isTouched(id){
    const el = document.getElementById(id);
    return el && el.dataset.touched === "1";
  }
  function markTouched(id){
    const el = document.getElementById(id);
    if(el) el.dataset.touched = "1";
  }

  function validPin4(pin){ return /^\d{4}$/.test(String(pin||"").trim()); }

  function validateNetflix(){
    const phone = document.getElementById("phoneNetflix").value.trim();
    const pin = document.getElementById("pinNetflix").value.trim();
    const opt = document.getElementById("opcionNetflix").value;

    const okPhone = phone !== "";
    const okPin = validPin4(pin);
    const okOpt = opt !== "";

    // errores solo si ya tocaron el campo (no apenas carga)
    if(isTouched("phoneNetflix")) setFieldError("phoneNetflix","errPhoneNetflix", okPhone ? "" : "‚ö†Ô∏è Ingresa tu n√∫mero de celular");
    if(isTouched("pinNetflix")) setFieldError("pinNetflix","errPinNetflix", okPin ? "" : "‚ö†Ô∏è El PIN debe tener 4 d√≠gitos");
    if(isTouched("opcionNetflix")) setFieldError("opcionNetflix","errOptNetflix", okOpt ? "" : "‚ö†Ô∏è Debes seleccionar una opci√≥n");

    const cooldown = Date.now() < cooldownUntil.netflix;
    const enable = okPhone && okPin && okOpt && !cooldown;

    document.getElementById("btnSearchNetflix").disabled = !enable;
    document.getElementById("btnRetryNetflix").disabled = !enable;
  }

  function validateDisney(){
    const phone = document.getElementById("phoneDisney").value.trim();
    const pin = document.getElementById("pinDisney").value.trim();
    const motivo = document.getElementById("motivoDisney").value;

    const okPhone = phone !== "";
    const okPin = validPin4(pin);
    const okMotivo = motivo !== "";

    if(isTouched("phoneDisney")) setFieldError("phoneDisney","errPhoneDisney", okPhone ? "" : "‚ö†Ô∏è Ingresa tu n√∫mero de celular");
    if(isTouched("pinDisney")) setFieldError("pinDisney","errPinDisney", okPin ? "" : "‚ö†Ô∏è El PIN debe tener 4 d√≠gitos");
    if(isTouched("motivoDisney")) setFieldError("motivoDisney","errMotivoDisney", okMotivo ? "" : "‚ö†Ô∏è Selecciona un motivo");

    const cooldown = Date.now() < cooldownUntil.disney;
    const enable = okPhone && okPin && okMotivo && !cooldown;

    document.getElementById("btnSearchDisney").disabled = !enable;
    document.getElementById("btnRetryDisney").disabled = !enable;
  }

  function validateAccount(){
    const phone = document.getElementById("phoneAccount").value.trim();
    const plat = document.getElementById("platform").value;

    const okPhone = phone !== "";
    const okPlat = plat !== "";

    if(isTouched("phoneAccount")) setFieldError("phoneAccount","errPhoneAccount", okPhone ? "" : "‚ö†Ô∏è Ingresa tu n√∫mero de celular");
    if(isTouched("platform")) setFieldError("platform","errPlatform", okPlat ? "" : "‚ö†Ô∏è Selecciona una plataforma");

    const cooldown = Date.now() < cooldownUntil.account;
    const enable = okPhone && okPlat && !cooldown;

    document.getElementById("btnAccount").disabled = !enable;
  }

  function validateAll(){
    validateNetflix();
    validateDisney();
    validateAccount();
  }

  // marcar touched cuando interact√∫a
  function wireTouched(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener("input", () => { markTouched(id); validateAll(); });
    el.addEventListener("change", () => { markTouched(id); validateAll(); });
    el.addEventListener("blur", () => { markTouched(id); validateAll(); });
  }

  /* ===== Renderers ===== */
  function renderNetflix(res){
    const emailMasked = esc(maskEmail(res.email || ""));
    const time = esc(res.timeText || "");
    const status = esc(res.statusText || "");
    const link = (res.link || "").trim();

    const isExpired = (res.kind === "expired");
    const titleCls = isExpired ? "yellowTitle" : "greenTitle";
    const icon = isExpired ? "‚ö†Ô∏è" : "‚úÖ";

    if(res.kind === "no_email"){
      return `
        <div class="resultTitle redTitle">‚ùå A√∫n no recibimos el correo de Netflix</div>
        <div class="line">Correo: <b>${emailMasked}</b></div>
        <div class="line">üì© <span class="label2">Buscado en:</span> <b>${emailMasked}</b></div>
        <div class="line">üßæ <span class="label2">Asunto:</span> <b>Tu c√≥digo de acceso temporal de Netflix</b></div>
        <div style="margin-top:10px; color: rgba(234,240,255,.78); font-size:12.5px; line-height:1.35; white-space:pre-line;">
          ${esc(NETFLIX_NO_EMAIL_COPY)}
        </div>
      `;
    }

    let linkBlock = "";
    if(!isExpired && link){
      linkBlock = `
        <div class="boxLink">${esc(link)}</div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary" onclick="window.open('${esc(link)}','_blank')">Abrir enlace</button>
          <button class="btn ghost" onclick="copyText('${esc(link)}')">Copiar enlace</button>
        </div>
      `;
    }

    let expireBlock = "";
    if(isExpired){
      expireBlock = `
        <div style="margin-top:10px; color: rgba(234,240,255,.78); font-size:12.5px; line-height:1.35;">
          üìù Este correo ya no es v√°lido (super√≥ los 15 minutos).<br>
          Reintenta para que tome el √∫ltimo c√≥digo enviado o reenv√≠a el email desde tu dispositivo.
        </div>
      `;
    }

    return `
      <div class="resultTitle ${titleCls}">${icon} Tu c√≥digo de acceso temporal de Netflix</div>
      <div class="line">Correo: <b>${emailMasked}</b></div>
      ${time ? `<div class="line">üïí <span class="label2">Hora:</span> <b>${time} (PET)</b></div>` : ``}
      <div class="line">üìå <span class="label2">Estado:</span> <b>${status}</b></div>
      <div class="line">üì© <span class="label2">Buscado en:</span> <b>${emailMasked}</b></div>
      <div class="line">üßæ <span class="label2">Asunto:</span> <b>Tu c√≥digo de acceso temporal de Netflix</b></div>
      ${linkBlock || expireBlock}
    `;
  }

  function renderDisney(res){
    const emailMasked = esc(maskEmail(res.email || ""));
    const time = esc(res.timeText || "");
    const status = esc(res.statusText || "");
    const code = String(res.code || "").trim();

    const isExpired = (res.kind === "expired");
    const titleCls = isExpired ? "yellowTitle" : "greenTitle";
    const icon = isExpired ? "‚ö†Ô∏è" : "‚úÖ";

    if(res.kind === "domain_not_supported"){
      return `
        <div class="resultTitle redTitle">‚ö†Ô∏è Solicitud no disponible</div>
        <div class="line">Correo: <b>${emailMasked}</b></div>
        <div class="line">üßæ <span class="label2">Asunto:</span> <b>Tu c√≥digo de acceso √∫nico para Disney+</b></div>
        <div style="margin-top:10px; color: rgba(234,240,255,.78); font-size:12.5px; line-height:1.35; white-space:pre-line;">
          ${esc(res.message || "Este correo no est√° habilitado para c√≥digos autom√°ticos. Contacta soporte.")}
        </div>
      `;
    }

    if(res.kind === "no_email"){
      return `
        <div class="resultTitle redTitle">‚ùå A√∫n no recibimos el correo de Disney+</div>
        <div class="line">Correo: <b>${emailMasked}</b></div>
        <div class="line">üì© <span class="label2">Buscado en:</span> <b>${emailMasked}</b></div>
        <div class="line">üßæ <span class="label2">Asunto:</span> <b>Tu c√≥digo de acceso √∫nico para Disney+</b></div>
        <div style="margin-top:10px; color: rgba(234,240,255,.78); font-size:12.5px; line-height:1.35; white-space:pre-line;">
          ${esc(res.message || "‚è≥ Espera 60 segundos y presiona Reintentar. Si persiste, contacta soporte.")}
        </div>
      `;
    }

    let codeBlock = "";
    if(!isExpired && code){
      codeBlock = `
        <div class="otpBox">${esc(code)}</div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary" onclick="copyText('${esc(code)}')">üìã Copiar c√≥digo</button>
        </div>
      `;
    }

    let expireBlock = "";
    if(isExpired){
      expireBlock = `
        <div style="margin-top:10px; color: rgba(234,240,255,.78); font-size:12.5px; line-height:1.35;">
          üìù Este correo ya no es v√°lido (super√≥ los 15 minutos).<br>
          Reintenta para que tome el √∫ltimo c√≥digo enviado o vuelve a solicitar el email desde tu dispositivo.
        </div>
      `;
    }

    return `
      <div class="resultTitle ${titleCls}">${icon} Tu c√≥digo de acceso √∫nico para Disney+</div>
      <div class="line">Correo: <b>${emailMasked}</b></div>
      ${time ? `<div class="line">üïí <span class="label2">Hora:</span> <b>${time} (PET)</b></div>` : ``}
      <div class="line">üìå <span class="label2">Estado:</span> <b>${status}</b></div>
      <div class="line">üì© <span class="label2">Buscado en:</span> <b>${emailMasked}</b></div>
      <div class="line">üßæ <span class="label2">Asunto:</span> <b>Tu c√≥digo de acceso √∫nico para Disney+</b></div>
      ${codeBlock || expireBlock}
    `;
  }

  function renderAccount(res){
    return `
      <div class="resultTitle greenTitle">üßæ Revisi√≥n de cuenta</div>
      <div class="line">üìå <span class="label2">Plataforma:</span> <b>${esc(res.platform || "")}</b></div>
      <div class="line">üìß <span class="label2">Correo:</span> <b>${esc(res.email || "")}</b></div>
      <div class="line">üîë <span class="label2">Contrase√±a:</span> <b>${esc(res.password || "")}</b></div>
      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn ghost" onclick="copyText('${esc(res.password || "")}')">Copiar contrase√±a</button>
        <button class="btn ghost" onclick="copyText('${esc(res.email || "")}')">Copiar correo</button>
      </div>
    `;
  }

  function renderSimpleWarn(title, msg){
    return `
      <div class="resultTitle yellowTitle">${esc(title)}</div>
      <div style="color:rgba(234,240,255,.78); font-size:12.5px; line-height:1.35; white-space:pre-line;">
        ${esc(msg)}
      </div>
    `;
  }

  // ---------- NETFLIX ----------
  function searchNetflix(){ runNetflix(); }
  function retryNetflix(){ runNetflix(); }

  async function runNetflix(){
    // Marca touched para mostrar errores si intentan apretar
    ["phoneNetflix","pinNetflix","opcionNetflix"].forEach(markTouched);
    validateNetflix();
    if (document.getElementById("btnSearchNetflix").disabled) return;

    startCooldown("netflix", ["btnSearchNetflix","btnRetryNetflix"], 30, "btnRetryNetflix");

    const phone = document.getElementById("phoneNetflix").value.trim();
    const pin = document.getElementById("pinNetflix").value.trim();
    const opcion = document.getElementById("opcionNetflix").value;

    outHTML("outNetflix", "");
    setLoader("loaderNetflix", true);

    // Simulaci√≥n front para Actualizar hogar
    if (opcion === "hogar") {
      setTimeout(() => {
        setLoader("loaderNetflix", false);
        outHTML("outNetflix", renderSimpleWarn("üè† Actualizar hogar (Netflix)", UPDATE_HOME_MESSAGE));
      }, 1200);
      return;
    }

    try{
      const res = await fetch(`${API_BASE}/api/portal/netflix`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ deviceId: getDeviceId(), phone, pin })
      });
      const data = await res.json();

      setLoader("loaderNetflix", false);
      if(typeof data.remaining === "number") setRemain("remainNetflix", data.remaining);

      if(data.ok && (data.kind === "valid" || data.kind === "expired")){
        outHTML("outNetflix", renderNetflix(data));
        return;
      }

      if(data && data.kind === "no_email"){
        outHTML("outNetflix", renderNetflix({ kind:"no_email", email: data.email || "" }));
        return;
      }

      outHTML("outNetflix", renderError("No se pudo completar", data.message || "Intenta nuevamente."));
    }catch(e){
      setLoader("loaderNetflix", false);
      outHTML("outNetflix", renderError("Error de conexi√≥n", "Intenta nuevamente."));
    }
  }

  // ---------- DISNEY ----------
  function searchDisney(){ runDisney(); }
  function retryDisney(){ runDisney(); }

  async function runDisney(){
    ["phoneDisney","pinDisney","motivoDisney"].forEach(markTouched);
    validateDisney();
    if (document.getElementById("btnSearchDisney").disabled) return;

    startCooldown("disney", ["btnSearchDisney","btnRetryDisney"], 30, "btnRetryDisney");

    const phone = document.getElementById("phoneDisney").value.trim();
    const pin = document.getElementById("pinDisney").value.trim();
    const motivo = document.getElementById("motivoDisney").value;

    outHTML("outDisney", "");
    setLoader("loaderDisney", true);

    try{
      const res = await fetch(`${API_BASE}/api/portal/disney`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ deviceId: getDeviceId(), phone, pin, motivo })
      });
      const data = await res.json();

      setLoader("loaderDisney", false);
      if(typeof data.remaining === "number") setRemain("remainDisney", data.remaining);

      if(data.ok && (data.kind === "valid" || data.kind === "expired")){
        outHTML("outDisney", renderDisney(data));
        return;
      }

      if(data && (data.kind === "domain_not_supported" || data.kind === "no_email")){
        outHTML("outDisney", renderDisney(data));
        return;
      }

      outHTML("outDisney", renderError("No se pudo completar", data.message || "Intenta nuevamente."));
    }catch(e){
      setLoader("loaderDisney", false);
      outHTML("outDisney", renderError("Error de conexi√≥n", "Intenta nuevamente."));
    }
  }

  // ---------- ACCOUNT ----------
  async function checkAccount(){
    ["phoneAccount","platform"].forEach(markTouched);
    validateAccount();
    if (document.getElementById("btnAccount").disabled) return;

    startCooldown("account", ["btnAccount"], 10, null);

    const phone = document.getElementById("phoneAccount").value.trim();
    const platform = document.getElementById("platform").value;

    outHTML("outAccount", "");
    setLoader("loaderAccount", true);

    try{
      const res = await fetch(`${API_BASE}/api/portal/account`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ deviceId: getDeviceId(), phone, platform })
      });
      const data = await res.json();

      setLoader("loaderAccount", false);
      if(typeof data.remaining === "number") setRemain("remainAccount", data.remaining);

      if(data.ok && data.kind === "found"){
        outHTML("outAccount", renderAccount(data));
        return;
      }

      outHTML("outAccount", renderError("No se encontr√≥ informaci√≥n", data.message || "Verifica los datos."));
    }catch(e){
      setLoader("loaderAccount", false);
      outHTML("outAccount", renderError("Error de conexi√≥n", "Intenta nuevamente."));
    }
  }

  (function init(){
    // Platform select placeholder + options
    const sel = document.getElementById("platform");
    sel.innerHTML = "";

    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = "Seleccionar plataforma‚Ä¶";
    ph.disabled = true;
    ph.selected = true;
    sel.appendChild(ph);

    PLATFORMS.forEach(p => {
      const o = document.createElement("option");
      o.value = p;
      o.textContent = p;
      sel.appendChild(o);
    });

    setRemain("remainNetflix", null);
    setRemain("remainDisney", null);
    setRemain("remainAccount", null);

    // Wire touched + validation realtime
    [
      "phoneNetflix","pinNetflix","opcionNetflix",
      "phoneDisney","pinDisney","motivoDisney",
      "phoneAccount","platform"
    ].forEach(wireTouched);

    // Estado inicial (botones deshabilitados)
    validateAll();
  })();
</script>
</body>
</html>
